/* menapost 2014-10-02*/
!function(a){function b(a,b){this.id=a,this.name=b.prefix,this.offsetX=b.offsetX,this.offsetY=b.offsetY,this.width=b.width,this.height=b.height,this.type=b.type,this.emptyImage=b.emptyImage}function c(a){return a*S.scaleFactor}function d(){a(".loading-indicator").removeClass("hide")}function e(){a(".loading-indicator").addClass("hide")}function f(){fabric.Image.fromURL(kasra_eid_greeting.images_url+I.emptyImage,function(a){var b=c(I.offsetX)+c(I.width)/2-a.width/2,d=c(I.offsetY)+c(I.height)/2-a.height/2;a.set({left:b,top:d,selectable:!1}),K.sendBackwards(a),K.add(a)}),T.text(kasra_eid_greeting.take_a_photo)}function g(a){d(),fabric.Image.fromURL(I.getTemplatePath(),function(b){b.set({selectable:!1}),a.add(b),e()})}function h(b,c,d){var c=S.scaledWidth+"px",d=S.scaledHeight+"px";b.upperCanvasEl.style.width=c,b.upperCanvasEl.style.height=d,b.lowerCanvasEl.style.width=c,b.lowerCanvasEl.style.height=d,a(".canvas-container").css("width",c).css("height",d)}function i(){K?K.clear():(K=new fabric.Canvas("upload-image-canvas"),h(K),K.setBackgroundColor("#FFFFFF",K.renderAll.bind(K))),f(),g(K),a("#step2 .next-button").addClass("hide")}function j(){L?L.clear():(L=new fabric.Canvas("preview-image-canvas"),h(L),L.setBackgroundColor("#FFFFFF",L.renderAll.bind(L))),g(L),d(),r(M,L,function(a){previewCanvasPhotoImg=a,O={x:previewCanvasPhotoImg.scaleX,y:previewCanvasPhotoImg.scaleY},e()})}function k(b){G=b,a("#tabs li a.selected").removeClass("selected"),a('#tabs li a[href="#step'+G+'"]').addClass("selected"),a(".tabContent").addClass("hide").filter("#step"+G).removeClass("hide"),a(".app_container").trigger("step-change",G)}function l(){return!1}function m(){a("#tabs li a").on("click",l),a(".back-button").on("click",function(){k(--G)}),a(".next-button").on("click",function(){k(++G)}),V.on("click",D),a(".app_container").on("step-change",function(a,b){switch(b){case 1:n();break;case 3:j()}})}function n(){J&&(q(),f(),a(".image-placeholder").removeClass("hide"),a(".webcam-preview, #allow-webcam-message").addClass("hide"),U.removeClass("hide"))}function o(){H=[];for(var c=0;c<R.length;c++)H[c]=new b(c,R[c]),a(".tabContent#step1 .stack_holder").append(H[c].getThumbHtml()),H[c].attachHandler()}function p(){a(".image-placeholder").addClass("hide"),a("#step2 .stack_holder").addClass(I.type),a("#allow-webcam-message").removeClass("hide"),J=a(".webcam-preview").removeClass("hide potrait landscape").addClass(I.type).photobooth(),T.text(kasra_eid_greeting.use_this_photo)}function q(){a("#step2 .stack_holder").removeClass(I.type),J.data("photobooth").destroy(),J=null}function r(a,b,e){d(),fabric.Image.fromURL(a,function(a){var d=I.getScaledPhotoDimensions(a.width,a.height);a.set({top:c(I.offsetY),left:c(I.offsetX),scaleX:d.width/a.width,scaleY:d.height/a.height,hasBorders:!1,hasControls:!1}),b.add(a),b.sendBackwards(a),b.setActiveObject(a),e(a)})}function s(b){M=b,N&&K.remove(N),d(),r(M,K,function(a){N=a,e()}),a("#step2 .next-button").removeClass("hide")}function t(){var b=J.data("photobooth").takeImage();q(),a(".image-placeholder").removeClass("hide"),a(".webcam-preview, #allow-webcam-message").addClass("hide"),T.text(kasra_eid_greeting.re_take_photo),s(b)}function u(){var b=new FormData;return this.files.length?(b.append("action","upload_file"),b.append("photo-file",this.files[0]),void a.ajax({url:kasra_eid_greeting.ajax_url,type:"POST",data:b,processData:!1,contentType:!1,success:function(a){a.success?s(a.data.url):alert(a.data.error)},error:function(a,b,c){alert(c)},beforeSend:function(){d(),U.prop("disabled","disabled"),T.prop("disabled","disabled")},complete:function(){e(),U.prop("disabled",""),T.prop("disabled","")}})):!0}function v(){a("#take-photo-button").on("click",function(){J?(t(),U.removeClass("hide")):(p(),a("#step2 .next-button").addClass("hide"),U.addClass("hide"))}),a("#upload-photo-button").on("click",function(){a("#file-select").click()}),y(),a("#file-select").on("change",u)}function w(){return/^((?!chrome).)*safari/i.test(navigator.userAgent)}function x(){var a=window.navigator.userAgent,b=a.indexOf("MSIE "),c=a.indexOf("Trident/");if(b>0)return parseInt(a.substring(b+5,a.indexOf(".",b)),10);if(c>0){var d=a.indexOf("rv:");return parseInt(a.substring(d+3,a.indexOf(".",d)),10)}return!1}function y(){(x()||w())&&T.hide()}function z(a){var b=10*a;previewCanvasPhotoImg.rotate(b),L.renderAll()}function A(a){var b=parseFloat(a)+O.x-1,c=parseFloat(a)+O.y-1;previewCanvasPhotoImg.setScaleX(b),previewCanvasPhotoImg.setScaleY(c),L.renderAll()}function B(){a("#scale-slider").on("input",function(){A(a(this).val())}),a("#rotate-slider").on("input",function(){z(a(this).val())})}function C(){m(),v(),B()}function D(){var b=L.toDataURL("image/png");d(),V.prop("disabled","disabled"),a.ajax({url:kasra_eid_greeting.ajax_url,method:"post",data:{action:"save_file",imageData:b}}).done(function(b){b.success?(P=b.data.url,Q=b.data.resized_image,a("#share-card-preview").prop("src",P),a("#tabs").addClass("hide"),k(++G)):alert(b.data.error)}).fail(function(a){console.log(a)}).always(function(){e(),V.prop("disabled","")}),a("#share-card-button").on("click",function(){E(P)})}function E(){FB.ui({method:"feed",link:window.location.href,description:"كسرة ستساعدك هذا العيد في صنع بطاقة تهنئة مميزة وخاصة بك بمناسبة عيد الأضحى والتي يمكنك مشاركتها مع عائلتك وأصحابك\n",picture:Q,name:"عيد"},function(a){console.log(a),a&&a.post_id?location.href="/":alert("Unable to publish to facebook.")})}function F(){o(),k(1),C(),a(document).on("ready",function(){a('li a[data-query-value="عيد"]').addClass("active")}),a(".start_btn").on("click",function(){a(".container_bg").addClass("hide"),a(".app_container").removeClass("hide")})}var G,H,I,J,K,L,M,N,O,P,Q,R=(kasra_eid_greeting.images_url+"empty_img.jpg",[{prefix:"EidCard1",offsetX:0,offsetY:0,width:340,height:500,type:"potrait",emptyImage:"empty-card1.jpg"},{prefix:"EidCard2",offsetX:194,offsetY:188,width:290,height:194,type:"landscape",emptyImage:"empty-card2.jpg"},{prefix:"EidCard3",offsetX:170,offsetY:225,width:316,height:212,type:"landscape",emptyImage:"empty-card2.jpg"},{prefix:"EidCard4",offsetX:225,offsetY:135,width:260,height:256,type:"potrait",emptyImage:"empty-card4.jpg"}]),S={scaledWidth:500,scaledHeight:500,originalWidth:1200,originalHeight:1200,scaleFactor:2.4},T=a("#take-photo-button"),U=a("#upload-photo-button"),V=a("#finish-button");a.extend(b.prototype,{getTemplatePath:function(){return kasra_eid_greeting.images_url+this.name+"-template.png"},getThumbPath:function(){return kasra_eid_greeting.images_url+this.name+"-thumb.png"},getThumbHtml:function(){return'<div class="card" data-card-id="'+this.id+'"><img src="'+this.getThumbPath()+'"/></div>'},attachHandler:function(){a('[data-card-id="'+this.id+'"]').on("click",a.proxy(this.selectCard,this))},selectCard:function(){I=this,k(++G),i()},getScaledPhotoDimensions:function(a,b){var d,e,f,g;return d=c(this.width)/a,e=c(this.height)/b,d>e?(f=a*d,g=b*f/a):(g=b*e,f=a*g/b),{width:f,height:g}}}),F()}(jQuery);